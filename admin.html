<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio CMS - Admin</title>
    <style>
        /* Import Public Sans */
        @import url('https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --red: #dc2626;
            --black: #000000;
            --white: #ffffff;
            --grey: #f5f5f5;
            --dark-grey: #333333;
            --green: #10b981;
            --blue: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Public Sans', system-ui, sans-serif;
            background: var(--grey);
            color: var(--black);
            cursor: url('cursor.png') 16 16, auto;
        }

        a, button, .clickable {
            cursor: url('cursor.png') 16 16, pointer;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--red);
        }

        .login-form {
            background: var(--white);
            padding: 40px;
            border: 3px solid var(--black);
            min-width: 400px;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 30px;
            text-align: center;
            color: var(--black);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--black);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--red);
        }

        .btn {
            padding: 12px 24px;
            border: 3px solid var(--black);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: url('cursor.png') 16 16, pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--red);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--black);
            border-color: var(--red);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
        }

        .btn-secondary:hover {
            background: var(--black);
            color: var(--white);
        }

        .btn-success {
            background: var(--green);
            color: var(--white);
            border-color: var(--green);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
            border-color: var(--red);
        }

        /* Admin Interface */
        .admin-interface {
            display: none;
        }

        .admin-header {
            background: var(--red);
            color: var(--white);
            padding: 20px;
            border-bottom: 3px solid var(--black);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 30px;
            color: var(--black);
            border-bottom: 3px solid var(--black);
            padding-bottom: 10px;
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed var(--black);
            padding: 40px;
            text-align: center;
            margin-bottom: 40px;
            background: var(--white);
            transition: all 0.3s;
        }

        .upload-area.dragover {
            border-color: var(--red);
            background: #fef2f2;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: var(--dark-grey);
            margin-bottom: 20px;
        }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .project-card {
            background: var(--white);
            border: 3px solid var(--black);
            overflow: hidden;
            transition: all 0.3s;
            cursor: move;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 5px 5px 0 var(--black);
        }

        .project-card.editing {
            border-color: var(--blue);
        }

        .project-header {
            padding: 20px;
            background: var(--black);
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-title-edit {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 1.2rem;
            font-weight: 600;
            font-family: inherit;
            flex: 1;
        }

        .project-title-edit:focus {
            outline: 1px solid var(--white);
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .project-content {
            padding: 20px;
        }

        .project-medium-edit {
            width: 100%;
            border: 2px solid var(--grey);
            padding: 8px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .project-description-edit {
            width: 100%;
            min-height: 100px;
            border: 2px solid var(--grey);
            padding: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .project-media {
            margin-top: 20px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .media-item {
            position: relative;
            aspect-ratio: 1;
            background: var(--grey);
            border: 2px solid var(--black);
            overflow: hidden;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pdf-thumbnail {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--primary);
            background: var(--grey-light);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-group label {
            font-weight: 600;
            color: var(--black);
        }

        .setting-group input, .setting-group textarea {
            padding: 10px;
            border: 2px solid var(--grey-light);
            font-family: inherit;
            font-size: 1rem;
        }

        .setting-group input:focus, .setting-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .drag-handle {
            position: absolute;
            bottom: 5px;
            right: 5px;
            color: var(--primary);
            font-size: 12px;
            font-weight: bold;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-item:hover .drag-handle {
            opacity: 1;
        }

        .media-item.dragging {
            opacity: 0.5;
        }

        .sortable-media.drag-over {
            background: rgba(251, 108, 30, 0.1);
            border: 2px dashed var(--primary);
        }

        .media-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--red);
            color: var(--white);
            border: none;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: url('cursor.png') 16 16, pointer;
        }

        .drop-zone {
            border: 2px dashed var(--grey);
            padding: 20px;
            text-align: center;
            color: var(--dark-grey);
            margin-top: 15px;
        }

        .drop-zone.dragover {
            border-color: var(--blue);
            background: #eff6ff;
        }

        /* Status Messages */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border: 2px solid;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-success {
            background: var(--green);
            color: var(--white);
            border-color: var(--green);
        }

        .status-error {
            background: var(--red);
            color: var(--white);
            border-color: var(--red);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border: 3px solid var(--black);
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .admin-actions {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 3px solid var(--grey);
            border-top: 3px solid var(--red);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hero Image Manager Styles */
        .hero-image-manager {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .hero-preview {
            position: relative;
            width: 100%;
            height: 300px;
            border: 3px solid var(--black);
            overflow: hidden;
            background: #f0f0f0;
        }

        .hero-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            color: var(--white);
            padding: 20px;
        }

        .hero-text h3 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .hero-text p {
            font-size: 1rem;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .hero-upload-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .upload-hint {
            color: var(--dark-grey);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .hero-image-manager {
                grid-template-columns: 1fr;
            }
            
            .hero-preview {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <form class="login-form" id="loginForm">
            <h1 class="login-title">Portfolio CMS</h1>
            <div class="form-group">
                <label class="form-label" for="username">Username</label>
                <input type="text" id="username" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-input" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
        </form>
    </div>

    <!-- Admin Interface -->
    <div class="admin-interface" id="adminInterface">
        <header class="admin-header">
            <h1 class="admin-title">Portfolio CMS</h1>
            <div class="admin-actions">
                <button class="btn btn-success" id="saveAllBtn">
                    <span class="spinner" style="display: none;"></span>
                    Save All Changes
                </button>
                <button class="btn btn-secondary" id="addProjectBtn">Add Project</button>
                <button class="btn btn-secondary" id="logoutBtn">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <!-- File Upload Area -->
            <section>
                <h2 class="section-title">Upload Files</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-text">Drag & Drop files here</div>
                    <div class="upload-subtext">Or click to select files (Images, Videos & PDFs)</div>
                    <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf,application/pdf" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                        Choose Files
                    </button>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="spinner"></div>
                    Uploading files...
                </div>
                <div id="uploadedFiles" class="media-grid" style="margin-top: 20px;"></div>
            </section>

            <!-- Site Settings -->
            <section>
                <h2 class="section-title">Site Settings</h2>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="siteTitle">Hero Title</label>
                        <input type="text" id="siteTitle" placeholder="e.g., Fotógrafo y Artista Visual">
                    </div>
                    <div class="setting-group">
                        <label for="siteSubtitle">Hero Subtitle</label>
                        <input type="text" id="siteSubtitle" placeholder="e.g., Capturando momentos únicos a través de mi lente">
                    </div>
                    <div class="setting-group">
                        <label for="contactTitle">Contact Section Title</label>
                        <input type="text" id="contactTitle" placeholder="e.g., Contacto">
                    </div>
                    <div class="setting-group">
                        <label for="contactText">Contact Section Text</label>
                        <input type="text" id="contactText" placeholder="e.g., ¿Interesado en trabajar juntos?">
                    </div>
                    <div class="setting-group">
                        <label for="contactEmail">Contact Email</label>
                        <input type="email" id="contactEmail" placeholder="e.g., tu@email.com">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </section>

            <!-- Login Hero Image Management -->
            <section>
                <h2 class="section-title">Login Hero Image</h2>
                <div class="hero-image-manager">
                    <div class="current-hero-display">
                        <div class="hero-preview" id="heroPreview">
                            <img src="images/login-hero.jpg" alt="Current login hero image" id="heroImage">
                            <div class="hero-overlay">
                                <div class="hero-text">
                                    <h3>Gage Alexander Bearson</h3>
                                    <p>Visual Artist & Photographer</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hero-upload-controls">
                        <input type="file" id="heroFileInput" accept="image/*" style="display: none;" onchange="uploadHeroImage(this.files[0])">
                        <button class="btn btn-primary" onclick="document.getElementById('heroFileInput').click();">
                            Upload New Hero Image
                        </button>
                        <p class="upload-hint">Recommended: High-resolution image (1920x1080 or larger)</p>
                        <div id="heroUploadStatus" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </section>

            <!-- Projects Management -->
            <section>
                <h2 class="section-title">Projects</h2>
                <div class="projects-grid" id="projectsGrid">
                    <!-- Projects will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Status Messages -->
    <div class="status-message" id="statusMessage"></div>

    <!-- Modals -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 class="modal-title">Confirm Action</h3>
            <p id="confirmMessage"></p>
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let projects = {};
        let uploadedFiles = [];
        let currentEditingProject = null;

        // API helpers
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                showStatus('API Error: ' + error.message, 'error');
                throw error;
            }
        }

        // Authentication
        async function login(username, password) {
            try {
                await apiCall('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminInterface').style.display = 'block';
                loadSettings();
                loadProjects();
                showStatus('Login successful!', 'success');
            } catch (error) {
                showStatus('Invalid credentials', 'error');
            }
        }

        async function logout() {
            try {
                await apiCall('/api/logout', { method: 'POST' });
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminInterface').style.display = 'none';
                showStatus('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Check authentication status on load
        async function checkAuth() {
            try {
                const result = await apiCall('/api/auth-status');
                if (result.authenticated) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminInterface').style.display = 'block';
                    loadSettings();
                    loadProjects();
                }
            } catch (error) {
                console.log('Not authenticated');
            }
        }

        // Site Settings Management
        let siteSettings = {};

        async function loadSettings() {
            try {
                siteSettings = await apiCall('/api/settings');
                populateSettings();
            } catch (error) {
                console.log('No settings found, using defaults');
                siteSettings = {
                    heroTitle: 'Fotógrafo y Artista Visual',
                    heroSubtitle: 'Capturando momentos únicos a través de mi lente',
                    contactTitle: 'Contacto',
                    contactText: '¿Interesado en trabajar juntos?',
                    contactEmail: 'tu@email.com'
                };
                populateSettings();
            }
        }

        function populateSettings() {
            document.getElementById('siteTitle').value = siteSettings.heroTitle || '';
            document.getElementById('siteSubtitle').value = siteSettings.heroSubtitle || '';
            document.getElementById('contactTitle').value = siteSettings.contactTitle || '';
            document.getElementById('contactText').value = siteSettings.contactText || '';
            document.getElementById('contactEmail').value = siteSettings.contactEmail || '';
        }

        async function saveSettings() {
            const settings = {
                heroTitle: document.getElementById('siteTitle').value,
                heroSubtitle: document.getElementById('siteSubtitle').value,
                contactTitle: document.getElementById('contactTitle').value,
                contactText: document.getElementById('contactText').value,
                contactEmail: document.getElementById('contactEmail').value
            };

            try {
                await apiCall('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });
                siteSettings = settings;
                showStatus('Settings saved successfully!', 'success');
            } catch (error) {
                showStatus('Failed to save settings', 'error');
            }
        }

        // Projects management
        async function loadProjects() {
            try {
                projects = await apiCall('/api/projects');
                renderProjects();
            } catch (error) {
                showStatus('Failed to load projects', 'error');
            }
        }

        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            
            // Sort projects by order
            const sortedProjects = Object.entries(projects)
                .sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));
            
            grid.innerHTML = sortedProjects.map(([id, project]) => `
                <div class="project-card" data-project-id="${id}" draggable="true">
                    <div class="project-header">
                        <input type="text" class="project-title-edit" value="${project.title}" 
                               onchange="updateProject('${id}', 'title', this.value)">
                        <div class="project-actions">
                            <button class="btn btn-danger" onclick="deleteProject('${id}')" style="padding: 5px 10px;">×</button>
                        </div>
                    </div>
                    <div class="project-content">
                        <input type="text" class="project-medium-edit" value="${project.medium}"
                               placeholder="Medium (e.g., Photography)"
                               onchange="updateProject('${id}', 'medium', this.value)">
                        <textarea class="project-description-edit"
                                  onchange="updateProject('${id}', 'description', this.value)"
                                  placeholder="Project description...">${project.description}</textarea>
                        
                        <div class="project-media">
                            <div class="media-grid sortable-media" id="media-grid-${id}" data-project-id="${id}">
                                ${(project.images || []).map((img, index) => `
                                    <div class="media-item" draggable="true" data-type="images" data-url="${img}" data-index="${index}">
                                        <img src="${img}" alt="">
                                        <button class="media-remove" onclick="removeMedia('${id}', 'images', '${img}')">×</button>
                                        <div class="drag-handle">⋮⋮</div>
                                    </div>
                                `).join('')}
                                ${(project.videos || []).map((video, index) => `
                                    <div class="media-item" draggable="true" data-type="videos" data-url="${video}" data-index="${index}">
                                        <video src="${video}" muted preload="metadata">
                                            <div class="video-overlay">▶</div>
                                        </video>
                                        <button class="media-remove" onclick="removeMedia('${id}', 'videos', '${video}')">×</button>
                                        <div class="drag-handle">⋮⋮</div>
                                    </div>
                                `).join('')}
                                ${(project.pdfs || []).map((pdf, index) => `
                                    <div class="media-item" draggable="true" data-type="pdfs" data-url="${pdf}" data-index="${index}">
                                        <div class="pdf-thumbnail">📄</div>
                                        <button class="media-remove" onclick="removeMedia('${id}', 'pdfs', '${pdf}')">×</button>
                                        <div class="drag-handle">⋮⋮</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="project-upload-section">
                                <input type="file" id="project-file-input-${id}" multiple accept="image/*,video/*,.pdf,application/pdf" style="display: none;" onchange="uploadToProject('${id}', this.files)">
                                <button class="btn btn-secondary" onclick="document.getElementById('project-file-input-${id}').click()" style="margin-bottom: 10px;">📁 Upload Files</button>
                                <div class="drop-zone" 
                                     ondrop="dropMedia(event, '${id}')" 
                                     ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)"
                                     ondragleave="dragLeave(event)">
                                    Drop files here to add to project
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            initializeDragAndDrop();
            
            // Initialize media sorting for all projects
            Object.keys(projects).forEach(projectId => {
                initializeMediaSorting(projectId);
            });
        }

        async function updateProject(id, field, value) {
            projects[id][field] = value;
            showStatus('Changes saved locally. Click "Save All Changes" to publish.', 'success');
        }

        async function saveAllProjects() {
            const saveBtn = document.getElementById('saveAllBtn');
            const spinner = saveBtn.querySelector('.spinner');
            
            try {
                saveBtn.classList.add('loading');
                spinner.style.display = 'inline-block';
                
                // Save each project
                for (const [id, project] of Object.entries(projects)) {
                    await apiCall(`/api/projects/${id}`, {
                        method: 'POST',
                        body: JSON.stringify(project)
                    });
                }
                
                // Regenerate static files
                await apiCall('/api/regenerate', { method: 'POST' });
                
                showStatus('All changes saved and published!', 'success');
            } catch (error) {
                showStatus('Failed to save changes', 'error');
            } finally {
                saveBtn.classList.remove('loading');
                spinner.style.display = 'none';
            }
        }

        async function deleteProject(id) {
            showConfirm('Are you sure you want to delete this project?', async () => {
                try {
                    await apiCall(`/api/projects/${id}`, { method: 'DELETE' });
                    delete projects[id];
                    renderProjects();
                    showStatus('Project deleted', 'success');
                } catch (error) {
                    showStatus('Failed to delete project', 'error');
                }
            });
        }

        function addProject() {
            const id = 'project-' + Date.now();
            projects[id] = {
                title: 'New Project',
                medium: 'Photography',
                description: 'Project description...',
                images: [],
                videos: [],
                order: Object.keys(projects).length + 1
            };
            renderProjects();
            showStatus('New project added', 'success');
        }

        // File upload
        async function uploadFiles(files) {
            const progress = document.getElementById('uploadProgress');
            const uploadArea = document.getElementById('uploadArea');
            
            // Show progress
            progress.style.display = 'block';
            progress.innerHTML = `
                <div class="spinner"></div>
                Uploading ${files.length} file(s)... Please wait.
            `;
            uploadArea.style.opacity = '0.5';
            
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
                console.log('Adding file:', file.name, file.type, file.size);
            }
            
            try {
                console.log('Starting upload...');
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Upload response status:', response.status);
                const result = await response.json();
                console.log('Upload result:', result);
                
                if (result.success) {
                    uploadedFiles.push(...result.files);
                    renderUploadedFiles();
                    showStatus(`${result.files.length} files uploaded successfully!`, 'success');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Upload failed: ' + error.message, 'error');
            } finally {
                progress.style.display = 'none';
                uploadArea.style.opacity = '1';
            }
        }

        // Direct upload to specific project
        async function uploadToProject(projectId, files) {
            if (!files || files.length === 0) return;
            
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add uploaded files directly to the project
                    for (const fileData of result.files) {
                        if (!projects[projectId].images) projects[projectId].images = [];
                        if (!projects[projectId].videos) projects[projectId].videos = [];
                        if (!projects[projectId].pdfs) projects[projectId].pdfs = [];
                        
                        if (fileData.type === 'image') {
                            projects[projectId].images.push(fileData.url);
                        } else if (fileData.type === 'video') {
                            projects[projectId].videos.push(fileData.url);
                        } else if (fileData.type === 'pdf') {
                            projects[projectId].pdfs.push(fileData.url);
                        }
                    }
                    
                    // Re-render projects to show new files
                    renderProjects();
                    showStatus(`${result.files.length} files added to project!`, 'success');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                showStatus('Upload failed: ' + error.message, 'error');
            }
        }

        // Hero image upload function
        async function uploadHeroImage(file) {
            if (!file) return;
            
            const statusDiv = document.getElementById('heroUploadStatus');
            const heroImg = document.getElementById('heroImage');
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                statusDiv.innerHTML = '<span style="color: var(--red);">Please select a valid image file</span>';
                return;
            }
            
            // Show uploading status
            statusDiv.innerHTML = '<div class="spinner"></div> Uploading hero image...';
            
            const formData = new FormData();
            formData.append('files', file);
            formData.append('heroImage', 'true'); // Special flag for hero images
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.files.length > 0) {
                    const heroImageUrl = result.files[0].url;
                    
                    // Update the preview
                    heroImg.src = heroImageUrl + '?t=' + Date.now(); // Cache bust
                    
                    // Update the main site's background image
                    await updateHeroImageInSite(heroImageUrl);
                    
                    statusDiv.innerHTML = '<span style="color: var(--green);">✓ Hero image updated successfully!</span>';
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: var(--red);">Upload failed: ${error.message}</span>`;
            }
        }

        // Update hero image in the main site
        async function updateHeroImageInSite(imageUrl) {
            try {
                // Save to site settings or update directly
                await apiCall('/api/hero-image', {
                    method: 'POST',
                    body: JSON.stringify({ heroImage: imageUrl })
                });
                
                // Regenerate static files to update the main index.html
                await apiCall('/api/regenerate', { method: 'POST' });
            } catch (error) {
                console.error('Failed to update hero image in site:', error);
            }
        }

        function renderUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = uploadedFiles.map(file => `
                <div class="media-item" draggable="true" data-file-url="${file.url}" data-file-type="${file.type}" data-drag-type="media">
                    ${file.type === 'image' ? 
                        `<img src="${file.url}" alt="${file.originalName}">` :
                        `<video src="${file.url}" muted preload="metadata" style="object-fit: cover;">
                         <div class="video-overlay">▶</div>
                         </video>`
                    }
                    <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; font-size: 0.8rem;">
                        ${file.originalName}
                    </div>
                </div>
            `).join('');
            
            // Make uploaded files draggable
            container.querySelectorAll('.media-item').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    const fileData = {
                        url: this.dataset.fileUrl,
                        type: this.dataset.fileType,
                        dragType: 'media'
                    };
                    e.dataTransfer.setData('text/plain', JSON.stringify(fileData));
                    e.dataTransfer.setData('application/json', JSON.stringify(fileData));
                    console.log('Starting drag with data:', fileData);
                });
            });
        }

        // Drag and drop
        function initializeDragAndDrop() {
            const projectCards = document.querySelectorAll('.project-card');
            projectCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            const projectData = {
                projectId: this.dataset.projectId,
                dragType: 'project'
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(projectData));
            console.log('Starting project drag:', projectData);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            
            try {
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                console.log('Drop data received:', dragData);
                
                if (dragData.dragType === 'project') {
                    const dropZone = e.target.closest('.project-card');
                    if (dropZone && dragData.projectId !== dropZone.dataset.projectId) {
                        console.log('Reordering projects:', dragData.projectId, '→', dropZone.dataset.projectId);
                        reorderProjects(dragData.projectId, dropZone.dataset.projectId);
                    }
                }
            } catch (error) {
                console.log('Could not parse drag data for project reordering:', error);
            }
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dragEnter(event) {
            event.target.classList.add('dragover');
        }

        function dragLeave(event) {
            event.target.classList.remove('dragover');
        }

        function dropMedia(event, projectId) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            
            try {
                console.log('Dropping media into project:', projectId);
                
                // Try to get data from different sources
                let fileData = null;
                let rawData = '';
                
                // Try different data transfer types
                try {
                    rawData = event.dataTransfer.getData('text/plain');
                    if (rawData && rawData.trim()) {
                        fileData = JSON.parse(rawData);
                    }
                } catch (parseError) {
                    console.log('Failed to parse text/plain, trying application/json');
                    try {
                        rawData = event.dataTransfer.getData('application/json');
                        if (rawData && rawData.trim()) {
                            fileData = JSON.parse(rawData);
                        }
                    } catch (parseError2) {
                        console.log('Failed to parse application/json');
                    }
                }
                
                if (!fileData) {
                    console.error('No valid file data found. Raw data:', rawData);
                    showStatus('No valid file data found. Make sure the file was uploaded first.', 'error');
                    return;
                }
                
                console.log('File data:', fileData);
                
                // Only process media drops, not project reordering
                if (fileData.dragType !== 'media') {
                    console.log('Not a media drop, ignoring');
                    return;
                }
                
                // Validate required fields
                if (!fileData.url || !fileData.type) {
                    console.error('Invalid file data - missing url or type:', fileData);
                    showStatus('Invalid file data. Please try uploading the file again.', 'error');
                    return;
                }
                
                // Initialize arrays if they don't exist
                if (!projects[projectId].images) projects[projectId].images = [];
                if (!projects[projectId].videos) projects[projectId].videos = [];
                if (!projects[projectId].pdfs) projects[projectId].pdfs = [];
                
                if (fileData.type === 'image') {
                    projects[projectId].images.push(fileData.url);
                    console.log('Added image to project:', fileData.url);
                } else if (fileData.type === 'video') {
                    projects[projectId].videos.push(fileData.url);
                    console.log('Added video to project:', fileData.url);
                } else if (fileData.type === 'pdf') {
                    projects[projectId].pdfs.push(fileData.url);
                    console.log('Added PDF to project:', fileData.url);
                }
                
                console.log('Updated project:', projects[projectId]);
                
                // Update just this project's media grid
                updateProjectMediaGrid(projectId);
                showStatus(`${fileData.type === 'image' ? 'Image' : 'Video'} added to project`, 'success');
            } catch (error) {
                console.error('Drop error:', error);
                showStatus('Failed to add media: ' + error.message, 'error');
            }
        }

        function updateProjectMediaGrid(projectId) {
            const project = projects[projectId];
            const mediaGrid = document.getElementById(`media-grid-${projectId}`);
            
            if (mediaGrid) {
                mediaGrid.innerHTML = `
                    ${(project.images || []).map((img, index) => `
                        <div class="media-item" draggable="true" data-type="images" data-url="${img}" data-index="${index}">
                            <img src="${img}" alt="">
                            <button class="media-remove" onclick="removeMedia('${projectId}', 'images', '${img}')">×</button>
                            <div class="drag-handle">⋮⋮</div>
                        </div>
                    `).join('')}
                    ${(project.videos || []).map((video, index) => `
                        <div class="media-item" draggable="true" data-type="videos" data-url="${video}" data-index="${index}">
                            <video src="${video}" muted preload="metadata" style="object-fit: cover;">
                            </video>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.5rem;">▶</div>
                            <button class="media-remove" onclick="removeMedia('${projectId}', 'videos', '${video}')">×</button>
                            <div class="drag-handle">⋮⋮</div>
                        </div>
                    `).join('')}
                    ${(project.pdfs || []).map((pdf, index) => `
                        <div class="media-item" draggable="true" data-type="pdfs" data-url="${pdf}" data-index="${index}">
                            <div class="pdf-thumbnail">📄</div>
                            <button class="media-remove" onclick="removeMedia('${projectId}', 'pdfs', '${pdf}')">×</button>
                            <div class="drag-handle">⋮⋮</div>
                        </div>
                    `).join('')}
                `;
                
                // Initialize sorting for this media grid
                initializeMediaSorting(projectId);
            }
        }

        // Initialize media sorting for a specific project
        function initializeMediaSorting(projectId) {
            const mediaGrid = document.getElementById(`media-grid-${projectId}`);
            if (!mediaGrid) return;
            
            const mediaItems = mediaGrid.querySelectorAll('.media-item');
            
            mediaItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        projectId: projectId,
                        type: this.dataset.type,
                        url: this.dataset.url,
                        index: parseInt(this.dataset.index)
                    }));
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });
            
            mediaGrid.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            
            mediaGrid.addEventListener('dragleave', function(e) {
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
            
            mediaGrid.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                try {
                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (dragData.projectId !== projectId) return; // Only allow same-project drops
                    
                    // Find drop target
                    const afterElement = getDragAfterElement(this, e.clientY);
                    const draggedElement = this.querySelector('.dragging');
                    
                    if (afterElement == null) {
                        this.appendChild(draggedElement);
                    } else {
                        this.insertBefore(draggedElement, afterElement);
                    }
                    
                    // Update the media order in the project data
                    updateMediaOrder(projectId);
                } catch (error) {
                    console.error('Media sort error:', error);
                }
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.media-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updateMediaOrder(projectId) {
            const mediaGrid = document.getElementById(`media-grid-${projectId}`);
            const mediaItems = [...mediaGrid.querySelectorAll('.media-item')];
            
            // Rebuild arrays in new order
            const newImages = [];
            const newVideos = [];
            const newPdfs = [];
            
            mediaItems.forEach(item => {
                const type = item.dataset.type;
                const url = item.dataset.url;
                
                if (type === 'images') newImages.push(url);
                else if (type === 'videos') newVideos.push(url);
                else if (type === 'pdfs') newPdfs.push(url);
            });
            
            // Update project data
            projects[projectId].images = newImages;
            projects[projectId].videos = newVideos;
            projects[projectId].pdfs = newPdfs;
            
            // Refresh the grid with new order
            updateProjectMediaGrid(projectId);
            showStatus('Media reordered', 'success');
        }

        function removeMedia(projectId, type, url) {
            projects[projectId][type] = projects[projectId][type].filter(item => item !== url);
            updateProjectMediaGrid(projectId);
            showStatus('Media removed', 'success');
        }

        function reorderProjects(draggedId, targetId) {
            // Simple reordering logic - can be enhanced
            const draggedOrder = projects[draggedId].order;
            const targetOrder = projects[targetId].order;
            
            projects[draggedId].order = targetOrder;
            projects[targetId].order = draggedOrder;
            
            renderProjects();
            showStatus('Projects reordered', 'success');
        }

        // Utility functions
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 4000);
        }

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
            
            document.getElementById('confirmBtn').onclick = () => {
                closeModal('confirmModal');
                callback();
            };
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('saveAllBtn').addEventListener('click', saveAllProjects);
        document.getElementById('addProjectBtn').addEventListener('click', addProject);

        // File upload events
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            uploadFiles(Array.from(e.dataTransfer.files));
        });

        fileInput.addEventListener('change', (e) => {
            uploadFiles(Array.from(e.target.files));
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>